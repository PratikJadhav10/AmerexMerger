<!DOCTYPE html>
<html>

<head>
	<title>Search Form</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
	<!--<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

	<!-- Include flatpickr JavaScript -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<!--Below is script library of code mirror to display formatted XML data-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">
	<script src="script.js"></script>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 20px;
		}

		h1 {
			color: #333;
		}



		label {
			display: block;
			margin-top: 10px;
		}

		.radio-group {
			display: flex;
			align-items: center;
		}

		.radio-group label {
			margin-right: 10px;
		}

		.form-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		#centertext {
			text-align: center;
		}

		.form-row label {
			flex: 1;
			margin-right: 10px;
		}

		.form-row input[type="text"],
		.form-row input[type="date"] {
			flex: 2;
		}

		button {
			background-color: #4CAF50;
			color: white;
			padding: 10px 20px;
			border: none;
			cursor: pointer;
			margin-top: 10px;
		}

		textarea {
			width: 100%;
			padding: 10px;
			margin-top: 10px;
			border: 1px solid #ccc;
			border-radius: 4px;
		}
	</style>
</head>

<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/xml/xml.min.js"></script>

	<div class="container text-center">
		<h2>AmerexMerger</h2>
	</div>

	<form>

		<div class="container">
			<form>
				<div class="radio">
					<label><input type="radio" id="tradeRefOption" name="optradio" value="traderef"
							onclick="enableDateField()">Search by
						Traderef & date</label>
				</div>
				<div class="radio">
					<label><input type="radio" id="gatewayIdOption" name="optradio" value="gatewayid"
							onclick="disableDateField()">Search by
						Gateway ID</label>
				</div>
			</form>
		</div>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-4" style="background-color:rgb(255, 255, 255);">
					<form>
						<div class="form-group">
							<label for="usr">Trade Ref or Gateway ID:</label>
							<input type="text" class="form-control" id="bridgeRequestId" disabled>
						</div>
					</form>
				</div>
				<div class="col-sm-4" style="background-color:rgb(255, 255, 255);">
					<form>
						<div class="input-container">
							<label for="dateInput">Date:</label>
							<!--<input type="datetime-local" id="dateInput" name="dateInput" disabled>-->
							<!--min="2023-05-15T00:00" max="2023-05-18T00:00"-->
						</div>
						<div class="input-container">
							<input type="datetime-local" id="flatdateInput" name="dateInput2" class="datetimepicker"
								disabled>
							<!--min="2023-05-15T00:00" max="2023-05-18T00:00"-->
						</div>
						<div class="input-container">
							<label for="fromDateInput">From Date and Time:</label>
							<input type="datetime-local" id="fromDateInput" name="fromDateInput" class="datetimepicker"
								required>
						</div>
						<div class="input-container">
							<label for="toDateInput">To Date and Time:</label>
							<input type="datetime-local" id="toDateInput" name="toDateInput" class="datetimepicker"
								required>
						</div>

					</form>
				</div>
				<div class="col-sm-4" style="background-color:rgb(255, 255, 255);">
					<div class="form-group">
						<label for="dateInput">Source System:</label>
						<button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select
							<span class="caret"></span></button>
						<ul class="dropdown-menu">
							<li><a href="#">Option a</a></li>
							<li><a href="#">Option b</a></li>
							<li><a href="#">Option c</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<br>
		<!--<br>
		<label for="dateInput">Date:</label>
		<input type="datetime-local" id="dateInput" name="dateInput" disabled>
		<br>-->
		<div class="container text-center">
			<button type="button" id="displayBtn" class="btn btn-primary btn-sm btn-success" onclick="handleretrieve()">
				Retrieve
				XML
			</button>
		</div>
		<br>
		<div class="container">
			<form>
				<div class="form-group">
					<label for="comment"></label>
					<textarea class="form-control" rows="8" id="designationTextArea"></textarea>
				</div>
			</form>
		</div>
		<div id="dataContainer">
        <!-- Data will be displayed here -->
    </div>
		<!--<div>
		<table class="table table-striped">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">First</th>
      <th scope="col">Last</th>
      <th scope="col">Handle</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row">1</th>
      <td>Mark</td>
      <td>Otto</td>
      <td>@mdo</td>
    </tr>
    <tr>
      <th scope="row">2</th>
      <td>Jacob</td>
      <td>Thornton</td>
      <td>@fat</td>
    </tr>
    <tr>
      <th scope="row">3</th>
      <td>Larry</td>
      <td>the Bird</td>
      <td>@twitter</td>
    </tr>
  </tbody>
</table>
</div>-->
		<div class="container text-center">
			<button type="button" id="submitBtn" class="btn btn-primary btn-sm btn-success" onclick="postData()">
				Submit
			</button>
		</div>
		<div class="container text-center">
			(only enabled for failed data)
		</div>
		<br>
	</form>
	<script>

		function enableDateField() {
			document.getElementById('bridgeRequestId').disabled = false;
			document.getElementById('flatdateInput').disabled = false;
			var currentDate = new Date().toISOString().slice(0, 16);
			//document.getElementById('dateInput').min = currentDate;
			//document.getElementById('dateInput').max = currentDate;
			//document.getElementById('dateInput').value = currentDate;
			document.getElementById('bridgeRequestId').placeholder = "Enter TradeRef value";
		}

		function disableDateField() {
			document.getElementById('flatdateInput').disabled = true;
			document.getElementById('bridgeRequestId').disabled = false;
			document.getElementById('bridgeRequestId').placeholder = "Enter GatewayId";
		}

		function retrieveXML() {
			$(document).ready(function () {
				$("#displayBtn").click(function () {
					var bridgeRequestId = $("#bridgeRequestId").val();
					$.get("/data/new/" + bridgeRequestId, function (data) {
						$("#designationTextArea").val(data);
					});
				});
			});
			// Retrieve XML logic goes here
		}

		function retrieveXMLFromReqFileName() {
			/*$(document).ready(function () {
				$("#displayBtn").click(function () {
					var reqFileName = $("#bridgeRequestId").val();
					$.get("/data/new/reqFileName/" + reqFileName, function (data) {
						$("#designationTextArea").val(data);
					});
				});
			});*/
			console.log(1);
			//debugger;
			var reqFileName = $("#bridgeRequestId").val();
					$.get("/data/new/reqFileName/" + reqFileName, function (data) {
						$("#designationTextArea").val(data);
					});
		}

		function retrieveData() {
			$(document).ready(function () {
				$("#displayBtn").click(function () {
					var id = $("#bridgeRequestId").val();
					console.log("id:" + id);
					var date = new Date($("#flatdateInput").val());
					console.log("date:" + date);

					// Format the date in the desired format expected by the backend
					var formattedDate = date.toISOString();
					console.log("formatted date:" + formattedDate);

					$.get("/data/get/id/" + id, {date: formattedDate}, function (data) {
						$("#designationTextArea").val(data);
					}).fail(function () {
						$("#designationTextArea").val("Error retrieving data.");
					});
				});
			});
		}

		function retrieveDataFromTradeRefAndDate() {
			/*$(document).ready(function () {
				$("#displayBtn").click(function () {
					var tradeRef = $("#bridgeRequestId").val();
					console.log("id:" + tradeRef);
					var date = new Date($("#flatdateInput").val());
					console.log("date:" + date);

					// Format the date in the desired format expected by the backend
					var formattedDate = date.toISOString();
					console.log("formatted date:" + formattedDate);

					$.get("/data/get/tradeRefDate/" + tradeRef, {date: formattedDate}, function (data) {
						$("#designationTextArea").val(data);
					}).fail(function () {
						$("#designationTextArea").val("Error retrieving data.");
					});
				});
			});*/
			var tradeRef = $("#bridgeRequestId").val();
					console.log("id:" + tradeRef);
					var date = new Date($("#flatdateInput").val());
					console.log("date:" + date);

					// Format the date in the desired format expected by the backend
					var formattedDate = date.toISOString();
					console.log("formatted date:" + formattedDate);

					$.get("/data/get/tradeRefDate/" + tradeRef, {date: formattedDate}, function (data) {
						$("#designationTextArea").val(data);
					}).fail(function () {
						$("#designationTextArea").val("Error retrieving data.");
					});
		}

		function retrieveFromTradeRef() {
			$(document).ready(function () {
				$("#displayBtn").click(function () {
					var tradeRef = $("#bridgeRequestId").val();
					console.log(tradeRef);
					var dateTimeString = $("#flatdateInput").val();
					console.log(dateTimeString);

					var dateTime = new Date(dateTimeString);
					console.log(dateTime);

					// Format the date and time in the desired format expected by the backend
					var formattedDateTime = dateTime.toISOString();
					console.log(formattedDateTime);
					console.log(encodeURIComponent(formattedDateTime));

					$.get("/data/get/tradeRef/" + tradeRef + "/" + encodeURIComponent(formattedDateTime), function (data) {
						$("#designationTextArea").val(data);
					}).fail(function () {
						$("#designationTextArea").val("Error retrieving data.");
					});
				});
			});
		}


		



		$(document).ready(function () {
			$('#datetimepicker').datetimepicker({
				format: 'YYYY-MM-DD HH:mm:ss'
			});
			// Event listener for form submission
		document.getElementById('fetchDataForm').addEventListener('submit', function (event) {
			event.preventDefault();

			// Get the values from the form
			const tradeRef = document.getElementById('tradeRefInput').value;
			const date = document.getElementById('dateInput').value;

			// Call the fetchMessageLoad function
			fetchMessageLoad(tradeRef, date);
		});
		})


		function updateXML() {
			// Retrieve the updated data from the textarea
			var bridgeRequestId = $("#bridgeRequestId").val();
			var updatedData = $("#designationTextArea").val();
			console.log("hello there 1");

			// Prepare the data to be sent in the request body
			var requestBody = {
				bridgeRequestId: bridgeRequestId, // Replace with the actual record count
				updatedData: updatedData
			};

			// Get the CSRF token from the server
			$.get("/api/amerex/csrf-token", function (csrfToken) {
				// Include the CSRF token in the request headers
				$.ajax({
					url: "/api/amerex/updateData",
					type: "POST",
					contentType: "application/json",
					data: JSON.stringify(requestBody),
					headers: {
						"X-CSRF-TOKEN": csrfToken // Include the CSRF token in the request headers
					},
					success: function (response) {
						// Handle the response
						console.log(response);
						console.log("hello there");// Perform any additional actions after successful update
					},
					error: function (error) {
						// Handle any errors that occurred during the request
						console.error(error);
					}
				});
			});
			console.log("hello there 2");
		}



		function updateData() {
			// Retrieve the updated data from the textarea
			var updatedData = document.getElementById("textarea").value;

			// Prepare the data to be sent in the request body
			var requestBody = {
				recordCount: recordCount, // Replace with the actual record count
				updatedData: updatedData
			};

			// Send the AJAX request
			fetch("/api/amerex/updateData", {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify(requestBody)
			})
				.then(function (response) {
					// Handle the response
					if (response.ok) {
						return response.text();
					} else {
						throw new Error("Error updating data: " + response.status);
					}
				})
				.then(function (responseText) {
					// Display a success message or perform any other actions
					console.log(responseText);
				})
				.catch(function (error) {
					// Handle any errors that occurred during the request
					console.error(error);
				});
		}

		function postData() {
			// Retrieve the updated data from the textarea
			var bridgeRequestId = $("#bridgeRequestId").val();
			var updatedData = $("#designationTextArea").val();
			//var updatedData = document.getElementById("designationTextArea").value;
			//var bridgeRequestId = document.getElementById("bridgeRequestId").value;

			// Fetch the CSRF token
			fetch("/api/amerex/csrf-token")
				.then(function (response) {
					if (response.ok) {
						return response.text();
					} else {
						throw new Error("Error retrieving CSRF token: " + response.status);
					}
				})
				.then(function (csrfToken) {
					// Prepare the data to be sent in the request body
					var requestBody = {
						bridgeRequestId: parseInt(bridgeRequestId), // Convert to a number
						updatedData: updatedData
					};

					// Send the AJAX request with the CSRF token
					fetch(`/data/new/update/messageload?bridgeRequestId=${requestBody.bridgeRequestId}`, {
						method: "PUT",
						headers: {
							"Content-Type": "application/json",
							"X-CSRF-Token": csrfToken
						},
						body: JSON.stringify(requestBody.updatedData)
					})
						.then(function (response) {
							// Handle the response
							if (response.ok) {
								return response.text();
							} else {
								throw new Error("Error updating data: " + response.status);
							}
						})
						.then(function (responseText) {
							console.log("Successful");
							// Display a success message or perform any other actions
							console.log(responseText);
						})
						.catch(function (error) {
							// Handle any errors that occurred during the request
							console.log("Failed");
							console.error(error);
						});
				})
				.catch(function (error) {
					// Handle any errors that occurred during the CSRF token retrieval
					console.error(error);
				});
		}

		flatpickr(".datetimepicker", {
			enableTime: true, // Enable time selection
			dateFormat: "Y-m-d H:i", // Format of the selected date and time
		});

		/*Below is JS function of code mirror to display formatted XML data-->
		// Get the textarea element
		var textarea = document.getElementById("designationTextArea");
		var editor = CodeMirror.fromTextArea(textarea, {
			mode: "xml",
			lineNumbers: true

		});
        */
		//Below functionality is to handle the two different functions based on radio buttons selected.

		var retrieveBtn = document.getElementById("displayBtn");
		//retrieveBtn.addEventListener("click", handleretrieve);

		function handleretrieve() {
			var tradeRefOption = document.getElementById("tradeRefOption");
			var gatewayIdOption = document.getElementById("gatewayIdOption");
			var bridgeRequestId = document.getElementById("bridgeRequestId").value.trim();

			if (tradeRefOption.checked) {
				retrieveDataFromTradeRefAndDate(bridgeRequestId);
			} else if (gatewayIdOption.checked) {
				retrieveXMLFromReqFileName(bridgeRequestId);
			}
		}

		// Get the current date and time
		var currentDate = new Date();
		var currentYear = currentDate.getFullYear();
		var currentMonth = currentDate.getMonth() + 1; // Months are zero-based
		var currentDay = currentDate.getDate();
		var currentHour = currentDate.getHours();
		var currentMinute = currentDate.getMinutes();
		if (currentHour >= 12) {
			// If current time is 12:00 or later, set "From Date" to today at 12:00
			var fromDate = new Date(currentYear, currentMonth - 1, currentDay, 12, 0);
		} else {
			// If current time is before 12:00, set "From Date" to yesterday at 12:00
			var fromDate = new Date(currentYear, currentMonth - 1, currentDay - 1, 12, 0);
		}
		document.getElementById('fromDateInput').value = fromDate.toISOString().slice(0, 16);
		var toDate = new Date(currentYear, currentMonth - 1, currentDay + 30, 12, 0); // Set "To Date" to 30 days ahead at 12:00
		document.getElementById('toDateInput').value = toDate.toISOString().slice(0, 16);

		// Set the maximum date and time for the fromDateInput
		var maxFromDate = new Date(currentYear, currentMonth - 1, currentDay, 15, 30).toISOString().split('.')[0];
		document.getElementById('fromDateInput').max = maxFromDate;



	</script>
</body>

</html>